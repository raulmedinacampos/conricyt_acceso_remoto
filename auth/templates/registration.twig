{% extends 'master.twig' %}

{% block js %}
<script type="text/javascript" src='js/jquery.recaptcha.js'></script>
<script type="text/javascript">

var val_email1 = false;
var val_email2 = false;
var duplicado = 0;

$("input[name=inst_email]").focus(function(){
	$("#email1").nextAll().remove();
});

$("input[name=comm_email]").focus(function(){
	$("#email2").nextAll().remove();
});

$('#rfc').keyup(function() {
    this.value = this.value.toLocaleUpperCase();
});

$('#email1').keyup(function() {
    this.value = this.value.toLocaleLowerCase();
});

$('#email2').keyup(function() {
    this.value = this.value.toLocaleLowerCase();
});

$("input[name=inst_email], input[name=comm_email]").blur(function(){

	$("#email1").nextAll().remove();
	$("#email2").nextAll().remove();
	
	var email1 = $('#email1').val();
	var email2 = $('#email2').val();
			
	var data = {email1:email1, email2:email2};
		
	$.ajax({
		type: "POST",
		url: "validaEmail.php",
		data: data,
		dataType: "text",
		beforeSend: function(objeto){
			
        },
		success: function(data) {
		
			if(data=='rep0'){
				val_email1 = false;
				val_email2 = false;
			}else if(data=='rep1'){
				val_email1 = true;
				$("#email1").nextAll().remove();
				$("#email1").after('<font color="#FF0000">El email ya se encuentra registrado</font>');
			}else if(data=='rep2'){
				val_email2 = true;
				$("#email2").nextAll().remove();
				$("#email2").after('<font color="#FF0000">El email ya se encuentra registrado</font>');
			}
			
		},
		error: function(objeto, quepaso, otroobj){
        	
        }
	});
});

// Función para mostrar tooltips de los campos del formulario.
// Asignar clase masterTooltip y contenido del tooltip en title
$('.masterTooltip').hover(function() {
        // Al colocar el mouse sobre el campo
        var title = $(this).attr('title');
        $(this).data('tipText', title).removeAttr('title');
        $('<p class="tooltip"></p>')
        .html(title)
        .appendTo('body')
        .fadeIn(400);
}, function() {
        // Al quitar el cursor del campo
        $(this).attr('title', $(this).data('tipText'));
        $('.tooltip').remove();
}).mousemove(function(e) {
        var mousex = e.pageX + 20; //Get X coordinates
        var mousey = e.pageY + 10; //Get Y coordinates
        $('.tooltip')
        .css({ top: mousey, left: mousex })
});

$('.mostrarIMSS').css("display", "none");
$('label[for="facultad"] img').css("display", "none");
$('.camposOcultos').css("display", "none");

$('#myselect').change(function() {
	var inst = $(this).children("option:selected");
	$('.camposOcultos').css("display", "table-row");
	
	/* Se valida que sea el IMSS */
	if(inst.val() == 475) {
		$('.ocultarIMSS').css("display", "none");
		$('.mostrarIMSS').css("display", "table-row");
		$('label[for="id2"]').text("Matrícula IMSS*");
		$('label[for="facultad"] span').text("Adscripción* ");
		$('label[for="facultad"] img').css("display", "inline");
		$('label[for="email3"]').text("Correo electrónico personal*");
		$('label[for="email4"]').text("Correo electrónico institucional");
		$('#email1').attr("title", "El correo personal debe ser diferente al institucional");
		$('#email2').attr("title", "El correo institucional debe ser diferente al personal");
		
		$('#id').keyup(function() {
			var cuenta = $(this).val();
			if(cuenta.length >= 5) {
				$.post(
					'searchPreaproved.php',
					{'inst': 475, 'cuenta': cuenta},
					function(data) {
						var datos = jQuery.parseJSON(data);
						if(datos.length > 0) {
							$.each(datos, function(index, d) {
								if(d.firstname) {
									$('#firstname').val(d.firstname);
									$('#firstname').prop("disabled", true);
								}
								
								if(d.lastname1) {
									$('#lastname1').val(d.lastname1);
									$('#lastname1').prop("disabled", true);
								}
								
								if(d.lastname2) {
									$('#lastname2').val(d.lastname2);
									$('#lastname2').prop("disabled", true);
								}
								
								if(d.rfc) {
									$('#rfc').val(d.rfc);
									$('#rfc').prop("disabled", true);
								}
								
								if(d.homoclave) {
									$('#homoclave').val(d.homoclave);
									$('#homoclave').prop("disabled", true);
								}
								
								if(d.entidad) {
									$('#entidad').val(d.entidad);
									$('#entidad').prop("disabled", true);
								}
								
								if(d.gender) {
									$('#gender').val(d.gender);
									$('#gender').prop("disabled", true);
								}
								
								if(d.inst_email) {
									$('#email1').val(d.inst_email);
									$('#email1').prop("disabled", true);
								}
								
								if(d.comm_email) {
									$('#email2').val(d.comm_email);
									$('#email2').prop("disabled", true);
								}
								
								if(d.deleg_imss) {
									$('#delegacion').val(d.deleg_imss);
									$('#delegacion').prop("disabled", true);
								}
								
								if(d.clave_est_org) {
									$('#ceo').val(d.clave_est_org);
									$('#ceo').prop("disabled", true);
								}
								
								if(d.unit_faculty) {
									$('#unit_faculty').val(d.unit_faculty);
									$('#unit_faculty').prop("disabled", true);
								}
							});
						}
					}
				);
			}
		});
	} else {
		// Se deshabilita la propiedad de deshabilitado de los campos
		$('#firstname').prop("disabled", false);
		$('#lastname1').prop("disabled", false);
		$('#lastname2').prop("disabled", false);
		$('#rfc').prop("disabled", false);
		$('#homoclave').prop("disabled", false);
		$('#entidad').prop("disabled", false);
		$('#gender').prop("disabled", false);
		$('#email1').prop("disabled", false);
		$('#email2').prop("disabled", false);
		$('#delegacion').prop("disabled", false);
		$('#ceo').prop("disabled", false);
		$('#unit_faculty').prop("disabled", false);
		
		// Ocultamos y mostrar campos correspondientes
		$('.ocultarIMSS').css("display", "table-row");
		$('.mostrarIMSS').css("display", "none");
		$('label[for="id2"]').text("Matrícula*");
		$('label[for="facultad"] span').text("Dependencia o facultad* ");
		$('label[for="facultad"] img').css("display", "none");
		$('label[for="email3"]').text("Correo electrónico institucional*");
		$('label[for="email4"]').text("Correo electrónico personal");
		$('#email1').attr("title", "El correo institucional debe ser diferente al personal");
		$('#email2').attr("title", "El correo personal debe ser diferente al institucional");
	}
});

$('#perfil').change(function() {
	var tipoPerfil = $(this).children("option:selected").val();
	var role = "";
	
	$("#profile").html('<option value="">-- Seleccione Uno --</option>');
	/* Perfil estudiante */
	if(tipoPerfil == "es") {
		$('label[for="id2"]').text("Matricula/ No. de Cuenta*");
		$('label[for="perfil"]').text("Nivel Escolar*");

		role = 1;
	}
	
	/* Perfil académico o administrativo */
	if(tipoPerfil == "ac") {
		$('label[for="id2"]').text("No. de Empleado/ No. Económico*");
		$('label[for="perfil"]').text("Perfil*");
		
		role = 2;
	}
	
	$.post('getProfile.php',
		{perfil: role},
		function(data) {
			var datos = jQuery.parseJSON(data);
			var opciones = '';
			$.each(datos, function(index, op) {
				opciones += '<option value="'+op.id+'">'+op.name+'</option>';
			});
			$("#profile").append(opciones);
		}
	);
});

// Validacion de solicitud repetida
$('#id').blur(function() {
	var inst = $('#myselect').val();
	var cuenta = $(this).val();
	$.post(
		'validaDuplicado.php',
		{'inst': inst, 'cuenta': cuenta},
		function(data) {
			if(data == 1) {
				duplicado = 1;
			} else {
				duplicado = 0;
			}
		}
	);
});

$('#form1').validate({
	messages: {
		perfil: 'Este campo es obligatorio.',
		firstname: 'Este campo es obligatorio.',
		lastname1: 'Este campo es obligatorio.',
		entidad: 'Este campo es obligatorio.',
		gender: 'Este campo es obligatorio.',
		institution: 'Este campo es obligatorio.',
		account_num: 'Este campo es obligatorio.',
		comm_email: 'Correo electr&oacute;nico no valido.',
		inst_email: {
			required: 'Este campo es obligatorio.',
			email: 'Correo electr&oacute;nico no valido.'
		},
		profile: 'Este campo es obligatorio.',
		delegacion: 'Este campo es obligatorio.',
		ceo: 'Este campo es obligatorio.',
		unit_faculty: 'Este campo es obligatorio.',
		accept: 'Este campo es obligatorio.',
	},
	submitHandler: function(form){
			
		if($('#email1').val()==$('#email2').val()){
			alert('Correo comercial debe ser diferente al institucional');
			return false;
		}
		
		if(duplicado > 0) {
			alert('Ya has solicitado una cuenta con anterioridad');
			return false;
		}
		
		if($('#rfc').val().length > 0){
			rfc_regex = /[A-Z]{4}[0-9]{6}/;
			if(!rfc_regex.test($('#rfc').val())){
				$('#rfc_error').html('RFC debe ser cambiado al formato siguiente: XXXX000000, donde X es un carácter en mayúscula y el 0 es un carácter numérico').show();
				return false;
			
			}
		}
		
		if(!validateCaptcha()){
			return false;
		}

		if($('#honeypot').val() !== ''){
			return false;
		}
		
		if(val_email1 || val_email2){
			return false;
		}
		
		if(duplicado) {
			alert("Ya cuenta con un registro previo. Comuníquese al 5322 7700, extensión 4021 para mayor información");
			return false;
		}
		
		$('input, select').removeAttr('disabled');
		form.submit();
	}
});

</script>

{% endblock %}

{% block content %}
    
<div style="text-align:center; margin-top:20px; margin-left:40px">
<h2>Solicita tu cuenta de Acceso Remoto</h2>

<div align="center">
	<table border="1" width="640" id="table1" cellpadding="3" style="border-collapse: collapse" cellspacing="3">
		<tr>
			<td>
			<p align="center">Por favor <i>completa cuidadosamente</i> el siguiente formulario.<br>
			La informaci&oacute;n que proporciones para tu registro ser&aacute; validada por tu Instituci&oacute;n de origen.</td>
		</tr>
	</table>
</div>

<p><em>Los campos marcados con * son obligatorios. </em><br>
----> Se recomienda usar las versiones más recientes de los navegadores IE, Firefox o Chrome <---- </p>
	<form id="form1" name="form1" method="post" action="">
		<input type='hidden' name='honeypot' id='honeypot' value='' />
		<fieldset style="text-align:center;width:90%;border:2px dashed #255170; border-radius:8px;">
		<legend style="display:block;font-weight:bold;padding-bottom:1em; text-align:left">Formato de Registro </legend>
		
	<div style="width:850px; float:left; text-align:right">
	
	<table width="100%" style="font-size:14px;">
		<tr>
			<td width="400px"><label for="firstname">Nombre(s)*</label></td><td width="500px" style="text-align:left;"><input name="firstname" type="text" id="firstname" size="39" required data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="required:true,trim:true,maxLength:250,invalidMessage:'Este campo es requerido',missingMessage:'Este campo es requerido',promptMessage:'Escriba su(s) Nombre(s)<br>como desee que aparezca en su Constancia (obligatorio)'" /></td>
		</tr>
		<tr>
			<td><label for="lastname1">Apellido paterno*</label></td><td width="500px" style="text-align:left;"><input name="lastname1" type="text" id="lastname1" size="39" required type="text" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="required:true,trim:true,maxLength:250,invalidMessage:'Este campo es requerido',missingMessage:'Este campo es requerido',promptMessage:'Escriba su Apellido Paterno y Materno (obligatorio)'" /></td>
		</tr>
		<tr>
			<td><label for="lastname2">Apellido materno</label></td><td width="500px" style="text-align:left;"><input name="lastname2" type="text" id="lastname2" size="39" type="text" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="required:true,trim:true,maxLength:250,invalidMessage:'Este campo es requerido',missingMessage:'Este campo es requerido',promptMessage:'Escriba su Apellido Paterno y Materno (obligatorio)'" /></td>
		</tr>
		<tr>
			<td><label>Institución a la que pertenece*</label></td><td width="500px" style="text-align:left;"><select id='myselect' name='institution' required  style="width:200px; line-height: 25px;
    height: 25px; font-size:0.9em;" data-dojo-type="dijit.form.FilteringSelect" data-dojo-props="require:true,title:'Institucion',tooltip:'Seleccione el nombre de su Institución de procedencia (obligatorio)'">
	    <option value="">-- Seleccione una --</option>
				{% for institution in institutions %}
				<option value="{{ institution.id }}">{{ institution.inst_name }}</option>
				{% endfor %}
			</select></td>
		</tr>
		<tr class="ocultarIMSS camposOcultos">
			<td width="400px"><label for="firstname">Tipo de usuario</label></td><td width="500px" style="text-align:left;"><select name="perfil" id="perfil" size="1" style="width:200px; line-height: 25px; height: 25px" required="required">
			<option value="">-- Seleccione Uno --</option>
			<option value="es">Estudiante</option>
			<option value="ac">Académico o administrativo</option>
			</select></td>
		</tr>
		<tr class="camposOcultos">
			<td><label for="id2">Número de cuenta</label></td><td width="500px" style="text-align:left;"><input type="text" name="account_num" id="id" size="39" required /></td>
		</tr>
		<tr class="camposOcultos">
			<td><label for="rfc2">RFC</label></td><td width="500px" style="text-align:left;"><input style="text-transform: uppercase" type="text" name="rfc" id="rfc"  size="18" value="" style="color:#CCC" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="required:false,trim:true,maxLength:250,invalidMessage:'',missingMessage:'',promptMessage:'El RFC debe llevar 4 letras y 4 caracteres numéricos'" /><label for='rfc' id='rfc_error' class='error'></label></td>
		</tr>
		<tr class="camposOcultos">
			<td><label>Homoclave</label></td><td width="500px" style="text-align:left;"><input size="8" type='text' name='homoclave' id='homoclave' />
			<label for='rfc' id='homoclave_error' ></label></td>
		</tr>
		<tr class="camposOcultos">
			<td><label>Entidad federativa*</label></td><td width="500px" style="text-align:left;"><select name="entidad" id="entidad" size="1" style="width:200px; line-height: 25px; height: 25px" required>
          <option value="">-- Seleccione una --</option>
          
				{% for state in states %}
				
          <option value="{{ state.id }}">{{ state.entidad }}</option>
          
				{% endfor %}
			
        </select></td>
		</tr>
		<tr class="camposOcultos">
			<td><label>Sexo*</label></td><td width="500px" style="text-align:left;"><select name="gender" id="gender" size="1" style="width:200px; line-height: 25px;
    height: 25px" required>
          <option value="">-- Seleccione uno --</option>
          
				{% for gender in genders %}
				
          <option value="{{ gender.id }}">{{ gender.name|title }}</option>
          
				{% endfor %}
			
        </select></td>
		</tr>
		<tr class="camposOcultos">
			<td><label for="email3">Correo electrónico institucional*</label></td><td width="500px" style="text-align:left;"><input type="text" name="inst_email" id="email1" class='email masterTooltip' size="39" title="El correo personal debe ser diferente al institucional" required data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="validator:dojox.validate.isEmailAddress,required:true,trim:true,maxLength:250,invalidMessage:'Dirección de correo no valida',missingMessage:'Este campo es requerido',promptMessage:'Ingrese su dirección de<br>correo electrónico'" /></td>
		</tr>
		<tr class="camposOcultos">
			<td><label for="email4">Correo electrónico personal</label></td><td width="500px" style="text-align:left;"><input type="text" name="comm_email" id="email2" class='email masterTooltip' size="39" title="El correo personal debe ser diferente al institucional" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="validator:dojox.validate.isEmailAddress,required:true,trim:true,maxLength:50,invalidMessage:'Dirección de correo no valida',missingMessage:'Este campo es requerido',promptMessage:'Ingrese su dirección de<br>correo electrónico'" /></td>
		</tr>
		<tr class="ocultarIMSS camposOcultos">
			<td><label for="perfil">Perfil*</label></td><td width="500px" style="text-align:left;"><select name="profile" id="profile" size="1" required style="width:200px; line-height: 25px; height: 25px">
                <option value="">-- Seleccione uno --</option>
                
				{% for level in profile.levels %}
				
                <option value="{{ level.id }}">{{ level.name }}</option>
                
				{% endfor %}
			
              </select></td>
		</tr>
		<tr class="mostrarIMSS">
			<td><label for="delegacion">Delegación IMSS* <img alt="" src="images/qm.png" class='masterTooltip' title="Los usuarios de Nivel Central favor de<br />seleccionar la opción &quot;Oficinas Centrales&quot;.<br /><br />Los usuarios de nómina de mando favor de<br />seleccionar la opción &quot;Mando&quot; (Delegación<br />y Oficinas Centrales)" width="15px" /></label></td><td width="500px" style="text-align:left;"><select name="delegacion" id="delegacion" size="1" required style="width:200px; line-height: 25px; height: 25px">
                <option value="">-- Seleccione uno --</option>
                
				{% for delegacion in delegaciones %}
				
                <option value="{{ delegacion.id }}">{{ delegacion.delegacion }}</option>
                
				{% endfor %}
			
              </select></td>
		</tr>
		<tr class="mostrarIMSS">
			<td><label for="ceo">Clave Est Org/Clave departamental* <img alt="" src="images/qm.png" class='masterTooltip' title="La Clave de Estructura Organizacional o<br />Clave Departamental deberá obtenerla de<br />tu tarjetón de pago del IMSS.<br /><br />Ejemplo: 09NC012520" width="15px" /></label></td><td width="500px" style="text-align:left;"><input type="text" name="ceo" id="ceo" size="39"  required /></td>
		</tr>
		<tr class="camposOcultos">
			<td><label for="facultad"><span>Dependencia o Facultad* </span><img alt="" src="images/qm.png" class="masterTooltip" title="El nombre de su Adscripción deberá<br />obtenerlo de su tarjetón de pago vigente<br />IMSS.<br /><br />Ejemplo: División de Innovación Educativa" width="15px" /></label></td><td width="500px" style="text-align:left;"><input type="text" name="unit_faculty" id="unit_faculty" class="masterTooltip" size="39" title="Escuela, facultad o dependencia a la que está adscrito" required /></td>
		</tr>
	</table>
	
	</div>
	
	  <div style="text-align:center; clear:both" class="camposOcultos">
		<p>
			<label for="yes">Acepta los <a href='terms.pdf' target="_blank">Términos y Condiciones</a> del uso de la cuenta</label>
			<input type="checkbox" name="accept" id="yes" required/>
		</p>
        <div style="text-align:center">
        <em style="font-size:0.7em">Para continuar por favor escriba las palabras como se encuentran en la imagen de abajo. Si no es posible entender las letras, por favor de click en el ícono "actualizar" localizado a la derecha del cuadro donde se escribe. </em><br/>
		{{ recaptcha_form|raw }}
        </div>
		<p>
			<input type="hidden" name="setunique" id="setunique" value="{{ uniqueid }}" />
			<input type="submit" name="Registrar" id="Registrar" value="Registar" style="font-size:1.3em;"/>
			<input type="reset" name="Back" id="Back" value="Limpiar" style="margin-left:10px; font-size:1.3em;" />
		</p>
	  </div>
	</form>
		
		 
   <div style="float:left; font-size:0.7em"><a href="http://etechwebsite.com/conricyt/conricyt-select/">Regresar a la P&aacute;gina Anterior</a></div>
   </div>
{% endblock %}